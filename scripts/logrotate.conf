# ==========================================
# CONFIGURAÇÃO DE ROTAÇÃO DE LOGS - VIP ASSIST
# ==========================================
# Este arquivo configura a rotação automática de logs
# para evitar crescimento indefinido e consumo excessivo de disco
# ==========================================

# Logs do Docker (containers)
/var/lib/docker/containers/*/*.log {
    # Rotacionar diariamente
    daily
    
    # Manter logs dos últimos 7 dias
    rotate 7
    
    # Comprimir logs antigos
    compress
    
    # Não comprimir o log mais recente
    delaycompress
    
    # Não gerar erro se o arquivo não existir
    missingok
    
    # Não rotacionar se o arquivo estiver vazio
    notifempty
    
    # Criar novo arquivo com permissões específicas
    create 0644 root root
    
    # Usar data no nome do arquivo rotacionado
    dateext
    dateformat -%Y%m%d
    
    # Executar após rotação
    postrotate
        # Recarregar Docker para reconhecer novos arquivos de log
        docker kill --signal=HUP $(docker ps -q) 2>/dev/null || true
    endscript
    
    # Tamanho máximo antes de forçar rotação (100MB)
    maxsize 100M
}

# Logs do PostgreSQL
/var/log/postgresql/*.log {
    daily
    rotate 14
    compress
    delaycompress
    missingok
    notifempty
    create 0640 postgres postgres
    dateext
    dateformat -%Y%m%d
    
    postrotate
        # Recarregar PostgreSQL
        /usr/bin/pg_ctl reload -D /var/lib/postgresql/data 2>/dev/null || true
    endscript
    
    maxsize 50M
}

# Logs do Next.js (aplicação)
/var/log/vipassist/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 0644 www-data www-data
    dateext
    dateformat -%Y%m%d
    
    # Tamanho máximo de 200MB
    maxsize 200M
    
    # Executar script customizado após rotação
    postrotate
        # Notificar aplicação sobre rotação de logs
        echo "$(date): Logs rotacionados" >> /var/log/vipassist/rotation.log
    endscript
}

# Logs de backup
/backups/*.log {
    weekly
    rotate 12
    compress
    delaycompress
    missingok
    notifempty
    create 0644 root root
    dateext
    dateformat -%Y%m%d
    
    maxsize 10M
}

# Logs do Nginx (se usado como proxy reverso)
/var/log/nginx/*.log {
    daily
    rotate 14
    compress
    delaycompress
    missingok
    notifempty
    create 0640 nginx nginx
    dateext
    dateformat -%Y%m%d
    
    postrotate
        # Recarregar Nginx
        nginx -s reload 2>/dev/null || true
    endscript
    
    maxsize 100M
}

# Logs de acesso da aplicação
/var/log/vipassist/access.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 0644 www-data www-data
    dateext
    dateformat -%Y%m%d
    
    # Rotacionar por tamanho também (500MB)
    size 500M
    
    postrotate
        # Limpar logs muito antigos (mais de 90 dias)
        find /var/log/vipassist/ -name "access.log-*" -mtime +90 -delete
    endscript
}

# Logs de erro da aplicação
/var/log/vipassist/error.log {
    daily
    rotate 60
    compress
    delaycompress
    missingok
    notifempty
    create 0644 www-data www-data
    dateext
    dateformat -%Y%m%d
    
    # Manter logs de erro por mais tempo
    maxsize 100M
    
    # Enviar alerta se arquivo de erro crescer muito rápido
    postrotate
        SIZE=$(stat -f%z /var/log/vipassist/error.log 2>/dev/null || stat -c%s /var/log/vipassist/error.log 2>/dev/null || echo 0)
        if [ $SIZE -gt 10485760 ]; then
            echo "$(date): ALERTA - Arquivo de erro cresceu para $(($SIZE / 1048576))MB" >> /var/log/vipassist/alerts.log
        fi
    endscript
}

# Logs do sistema (syslog)
/var/log/syslog {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    create 0640 syslog adm
    dateext
    dateformat -%Y%m%d
    
    postrotate
        # Recarregar rsyslog
        /usr/lib/rsyslog/rsyslog-rotate 2>/dev/null || true
    endscript
    
    maxsize 100M
}

# ==========================================
# CONFIGURAÇÕES GLOBAIS
# ==========================================

# Comprimir com gzip
compresscmd /bin/gzip
compressext .gz
compressoptions -9

# Não enviar emails sobre rotações
nomail

# Usar sharedscripts para executar scripts uma vez por grupo
sharedscripts

# ==========================================
# NOTAS DE USO
# ==========================================
# 
# Para testar a configuração:
#   logrotate -d /etc/logrotate.d/vipassist
#
# Para forçar rotação imediata:
#   logrotate -f /etc/logrotate.d/vipassist
#
# Para verificar status:
#   cat /var/lib/logrotate/status
#
# ==========================================
